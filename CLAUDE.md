# CLAUDE.md

## Project

**Name:** Gridlock
**Stack:** React 19, TypeScript, Vite 7, CSS (no UI library)
**Repo:** github.com/nunpdsantos/gridlock
**Live:** gridlock-gilt.vercel.app
**PWA:** Installable on mobile via manifest.json + vite-plugin-pwa

## Commands

- `npm run build` — TypeScript check + Vite production build (also generates service worker)

## Architecture

### Game engine (`src/game/`)
- `constants.ts` — All tunable values: grid size, scoring, DDA thresholds, piece colors
- `types.ts` — Board, PieceShape, GameState, GameAction, LeaderboardEntry
- `logic.ts` — Pure functions: placement, line clearing, scoring, revive cell removal
- `pieces.ts` — 14 piece families (40 orientations), weighted random selection with DDA, piece-fit validation (20 retries + 1×1 fallback)
- `reducer.ts` — useReducer state machine: PLACE_PIECE, NEW_GAME, REVIVE, DISMISS_CELEBRATION

### Key patterns
- Game state is a `useReducer` — all mutations go through `reducer.ts`
- Drag system (`hooks/useDrag.ts`) caches `getBoundingClientRect` once per drag, batches updates via `requestAnimationFrame`, skips redundant ghost re-renders
- Line-clear animations use a two-phase approach: visual animation plays first (via `clearingCells` Set + CSS), then `dispatch` fires after `CLEAR_ANIMATION_MS` timeout
- Piece generation uses 5 multiplicative DDA systems: score ramp, pity timer, solution boost, streak pushback, board-state awareness
- Revive removes individual cells weighted by local congestion (not full rows), preserves combo streak
- 4 color themes via CSS variables on `[data-theme]` attribute, persisted in localStorage

### Screen flow
```
App (screen state + leaderboard + theme)
├── MainMenu → Play, Tutorial, Leaderboard, Theme picker
├── Tutorial → Visual how-to-play
├── Leaderboard → Top 5 local scores
└── Game → Board, PieceTray, DragOverlay, ScoreDisplay
    ├── PauseMenu overlay
    ├── GameOver overlay (Revive / Play Again / Menu)
    ├── CelebrationText (line clear feedback)
    └── Confetti (multi-clear particles)
```

## Gotchas

- `PIECE_COLORS` keys are used as the color pool — adding/removing colors changes piece variety
- Piece-fit validation in `generateThreePieces` validates each piece independently against the current board (not sequential simulation)
- `clearCellsForRevive` uses weighted random selection — results differ each time
- The DragOverlay renders via `createPortal` to document.body (outside React tree)
- Theme CSS variables must be defined for all 4 themes in `App.css` or cells will be invisible
- PWA service worker is auto-generated by vite-plugin-pwa on build — no manual sw.js file
